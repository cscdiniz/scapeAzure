{
	"name": "DF_ADL2STRUCTUREDToCURRENT_CDC",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "ADLStructured",
						"type": "DatasetReference"
					},
					"name": "StructuredFile"
				},
				{
					"dataset": {
						"referenceName": "AzureSynapseAnalytics",
						"type": "DatasetReference"
					},
					"name": "CurrentLookup"
				},
				{
					"dataset": {
						"referenceName": "GetSetMetadata",
						"type": "DatasetReference"
					},
					"name": "HASH"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "AzureSynapseAnalytics",
						"type": "DatasetReference"
					},
					"name": "CurrentSink"
				}
			],
			"transformations": [
				{
					"name": "AddColumns"
				},
				{
					"name": "Exists1"
				},
				{
					"name": "Select1"
				}
			],
			"script": "parameters{\n\tFile as string ('2022/01/24/Booking_1EA46AB0-E930-4D0A-891C-BD7D15E9F6B1.parquet'),\n\tDirectory as string ('Booking'),\n\tExecutionDate as timestamp,\n\tRunId as string\n}\nsource(output(\n\t\tBookingID as long,\n\t\tRoomSpaceID as long,\n\t\tEntryID as long,\n\t\tEntryStatusEnum as long,\n\t\tRoomTypeID as long,\n\t\tGroupID as long,\n\t\tRoomLocationID as long,\n\t\tStart_BookingReasonID as long,\n\t\tEnd_BookingReasonID as long,\n\t\tBookingTypeID as long,\n\t\tRoomRateID as long,\n\t\tBookingLinkTypeEnum as long,\n\t\tTermSessionID as long,\n\t\tHousekeepingID as long,\n\t\tEntryInvitationID as long,\n\t\tRoomLocationFixed as boolean,\n\t\tRoomRateAmount as double,\n\t\tCheckInDate as string,\n\t\tCheckOutDate as string,\n\t\tETA as long,\n\t\tETD as long,\n\t\tCheckInDateActual as string,\n\t\tCheckOutDateActual as string,\n\t\tDateChargedTo as string,\n\t\tContractDateStart as string,\n\t\tContractDateEnd as string,\n\t\tResvChargeToEntry as boolean,\n\t\tNumberOfGuests as long,\n\t\tNumberOfGuestsFree as long,\n\t\tNumberOfChildren as long,\n\t\tNumberOfChildrenFree as long,\n\t\tSpecialRequirement as string,\n\t\tComments as string,\n\t\tDateBilled as string,\n\t\tAutoAllocationDetail as string,\n\t\tAdditionalOccupantCount as long,\n\t\tEmotionalSupportAnimalCount as long,\n\t\tServiceAnimalCount as long,\n\t\tPetCount as long,\n\t\tPaidTo as string,\n\t\tExcess as double,\n\t\tCustomBit1 as boolean,\n\t\tCustomBit2 as boolean,\n\t\tCustomBit3 as boolean,\n\t\tCustomBit4 as boolean,\n\t\tCustomString1 as string,\n\t\tCustomString2 as string,\n\t\tCustomString3 as string,\n\t\tCustomString4 as string,\n\t\tCustomString5 as string,\n\t\tCustomString6 as string,\n\t\tCustomString7 as string,\n\t\tCustomString8 as string,\n\t\tCustomString9 as string,\n\t\tCustomString10 as string,\n\t\tCustomDate1 as string,\n\t\tCustomDate2 as string,\n\t\tCustomDate3 as string,\n\t\tCustomDate4 as string,\n\t\tSecurityUserID as long,\n\t\tDateModifiedBilling as string,\n\t\tDateCreated as string,\n\t\tDateModified as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\trowUrlColumn: 'FileName',\n\tformat: 'parquet') ~> StructuredFile\nsource(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\trowUrlColumn: 'FileName',\n\tpartitionRootPath: ($Directory),\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: (concat(\"Select * From stg.\", $Directory)),\n\tformat: 'query',\n\tstaged: true,\n\twildcardPaths:[(concat($Directory, '/*/*/*/*.parquet'))]) ~> CurrentLookup\nsource(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: (concat(\"EXEC [procfwkHelpers].[ReturnHASHMD5] @TableName ='\",$Directory, \"'\")),\n\tformat: 'query') ~> HASH\nStructuredFile derive(HASH = md5(concat(toString(coalesce(BookingID)), '|',toString(coalesce(RoomSpaceID)), '|',toString(coalesce(EntryID)), '|',toString(coalesce(EntryStatusEnum)), '|',toString(coalesce(RoomTypeID)), '|',toString(coalesce(GroupID)), '|',toString(coalesce(RoomLocationID)), '|',toString(coalesce(Start_BookingReasonID)), '|',toString(coalesce(End_BookingReasonID)), '|',toString(coalesce(BookingTypeID)), '|',toString(coalesce(RoomRateID)), '|',toString(coalesce(BookingLinkTypeEnum)), '|',toString(coalesce(TermSessionID)), '|',toString(coalesce(HousekeepingID)), '|',toString(coalesce(EntryInvitationID)), '|',toString(coalesce(RoomLocationFixed)), '|',toString(coalesce(RoomRateAmount)), '|',toString(coalesce(CheckInDate)), '|',toString(coalesce(CheckOutDate)), '|',toString(coalesce(ETA)), '|',toString(coalesce(ETD)), '|',toString(coalesce(CheckInDateActual)), '|',toString(coalesce(CheckOutDateActual)), '|',toString(coalesce(DateChargedTo)), '|',toString(coalesce(ContractDateStart)), '|',toString(coalesce(ContractDateEnd)), '|',toString(coalesce(ResvChargeToEntry)), '|',toString(coalesce(NumberOfGuests)), '|',toString(coalesce(NumberOfGuestsFree)), '|',toString(coalesce(NumberOfChildren)), '|',toString(coalesce(NumberOfChildrenFree)), '|',toString(coalesce(SpecialRequirement)), '|',toString(coalesce(Comments)), '|',toString(coalesce(DateBilled)), '|',toString(coalesce(AutoAllocationDetail)), '|',toString(coalesce(AdditionalOccupantCount)), '|',toString(coalesce(EmotionalSupportAnimalCount)), '|',toString(coalesce(ServiceAnimalCount)), '|',toString(coalesce(PetCount)), '|',toString(coalesce(PaidTo)), '|',toString(coalesce(Excess)), '|',toString(coalesce(CustomBit1)), '|',toString(coalesce(CustomBit2)), '|',toString(coalesce(CustomBit3)), '|',toString(coalesce(CustomBit4)), '|',toString(coalesce(CustomString1)), '|',toString(coalesce(CustomString2)), '|',toString(coalesce(CustomString3)), '|',toString(coalesce(CustomString4)), '|',toString(coalesce(CustomString5)), '|',toString(coalesce(CustomString6)), '|',toString(coalesce(CustomString7)), '|',toString(coalesce(CustomString8)), '|',toString(coalesce(CustomString9)), '|',toString(coalesce(CustomString10)), '|',toString(coalesce(CustomDate1)), '|',toString(coalesce(CustomDate2)), '|',toString(coalesce(CustomDate3)), '|',toString(coalesce(CustomDate4)), '|',toString(coalesce(SecurityUserID)), '|',toString(coalesce(DateModifiedBilling)), '|',toString(coalesce(DateCreated)), '|',toString(coalesce(DateModified)))),\n\t\tExecutionStatus = 'INSERT',\n\t\tExecutionCreatedDate = $ExecutionDate,\n\t\tExecutionModifiedDate = $ExecutionDate,\n\t\tExecutionLogId = $RunId) ~> AddColumns\nAddColumns, Select1 exists(HASH == HASH,\n\tnegate:true,\n\tbroadcast: 'both')~> Exists1\nCurrentLookup select(mapColumn(\n\t\tFileName,\n\t\teach(match(locate('hash',lower(name))==1),\n\t\t\t'HASH' = $$)\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select1\nExists1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tstaged: true,\n\tallowCopyCommand: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tpreCommands: [],\n\tpostCommands: []) ~> CurrentSink"
		}
	}
}